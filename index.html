<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Навигатор по знаниям — Елена Веселаго</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #fff;
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    /* Logo */
    .logo {
      text-align: center;
      margin-bottom: 2rem;
    }

    .logo img {
      width: 120px;
      height: 120px;
    }

    /* Search area */
    .search-area {
      margin-bottom: 2rem;
    }

    .search-box {
      display: flex;
      gap: 8px;
    }

    .search-box input {
      flex: 1;
      padding: 14px 18px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 10px;
      outline: none;
      transition: border-color 0.2s;
    }

    .search-box input:focus {
      border-color: #c0392b;
    }

    .search-box button {
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      background: #c0392b;
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .search-box button:hover {
      background: #a93226;
    }

    .search-box button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* 4 placeholder blocks for future */
    .blocks {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .block {
      display: none;
      padding: 2rem;
      background: #f7f7f7;
      border-radius: 12px;
      text-align: center;
    }

    /* Response area */
    .response-area {
      min-height: 100px;
      margin-bottom: 2rem;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 2rem;
      color: #999;
    }

    .loading .dots::after {
      content: '';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0% { content: ''; }
      25% { content: '.'; }
      50% { content: '..'; }
      75% { content: '...'; }
    }

    /* Error */
    .error {
      padding: 1rem 1.5rem;
      background: #fff5f5;
      border: 1px solid #fed7d7;
      border-radius: 12px;
      color: #c53030;
    }

    /* No results */
    .no-results {
      text-align: center;
      padding: 2rem;
      color: #667;
      font-style: italic;
    }

    .no-results p {
      margin-bottom: 0.5rem;
    }

    /* Fallback plain text */
    .fallback-text {
      padding: 1.2rem 1.5rem;
      background: #fafafa;
      border-radius: 12px;
      line-height: 1.7;
      font-size: 15px;
      white-space: pre-wrap;
    }

    .fallback-text a {
      color: #c0392b;
      text-decoration: none;
    }

    .fallback-text a:hover {
      text-decoration: underline;
    }

    /* ===== Citation cards ===== */
    .citation {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      padding: 16px;
      background: #fff;
      border-radius: 10px;
      border-left: 4px solid #c0392b;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
    }

    .citation-rank {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #c0392b;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      margin-top: 2px;
    }

    .citation-content {
      flex: 1;
      min-width: 0;
    }

    .citation-title {
      font-size: 15px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .citation-quote {
      margin: 0 0 10px 0;
      padding: 10px 14px;
      background: #fdf6f5;
      border-left: 3px solid #e0b4b0;
      border-radius: 4px;
      font-style: italic;
      line-height: 1.6;
      color: #444;
      font-size: 14px;
    }

    /* Collapsible full text */
    details.citation-details {
      margin-bottom: 8px;
    }

    details.citation-details summary,
    details.tag-article summary {
      cursor: pointer;
      color: #c0392b;
      font-size: 13px;
      padding: 4px 0;
      user-select: none;
      font-weight: 500;
    }

    details.citation-details summary:hover,
    details.tag-article summary:hover {
      text-decoration: underline;
    }

    details[open] > summary {
      margin-bottom: 8px;
    }

    .citation-full-text,
    .tag-article-text {
      padding: 12px;
      background: #f9fafb;
      border-radius: 6px;
      font-size: 14px;
      line-height: 1.65;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 400px;
      overflow-y: auto;
    }

    .source-link {
      display: inline-block;
      margin-top: 10px;
      padding: 4px 14px;
      font-size: 13px;
      color: #c0392b;
      border: 1px solid #c0392b;
      border-radius: 6px;
      text-decoration: none;
      transition: background 0.15s, color 0.15s;
    }

    .source-link:hover {
      background: #c0392b;
      color: #fff;
    }

    /* Tags on citations */
    .citation-tags {
      margin-top: 6px;
    }

    .tag {
      display: inline-block;
      padding: 2px 10px;
      margin: 2px 4px 2px 0;
      background: #f0e8e7;
      color: #8b3a32;
      border-radius: 12px;
      font-size: 12px;
    }

    /* ===== Related tags section ===== */
    .related-tags-section {
      margin-top: 24px;
      padding-top: 18px;
      border-top: 1px solid #eee;
    }

    .related-tags-heading {
      font-size: 15px;
      font-weight: 600;
      color: #555;
      margin-bottom: 14px;
    }

    .tag-group {
      margin-bottom: 14px;
    }

    .tag-group-name {
      display: inline-block;
      padding: 3px 12px;
      margin-bottom: 8px;
      background: #c0392b;
      color: #fff;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 500;
    }

    .tag-articles {
      margin-left: 8px;
    }

    details.tag-article {
      margin-bottom: 6px;
    }

    details.tag-article summary {
      font-size: 14px;
      color: #555;
      font-weight: 500;
    }

    details.tag-article summary:hover {
      color: #c0392b;
    }

    /* Conversation history */
    .history {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .history-item {
      border-bottom: 1px solid #f0f0f0;
      padding-bottom: 1rem;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-question {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #555;
      font-size: 14px;
    }

    .history-answer {
      opacity: 0.7;
      font-size: 14px;
    }

    /* Responsive */
    @media (max-width: 480px) {
      .container {
        padding: 1rem;
      }

      .search-box {
        flex-direction: column;
      }

      .search-box button {
        padding: 12px;
      }

      .citation {
        flex-direction: column;
        gap: 8px;
      }

      .citation-rank {
        width: 24px;
        height: 24px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <!-- Logo -->
    <div class="logo">
      <img src="logo.png" alt="Навигатор по знаниям">
    </div>

    <!-- Search -->
    <div class="search-area">
      <div class="search-box">
        <input type="text" id="query" placeholder="Задайте вопрос о расстановках, полевой терапии или шаманизме..." autofocus>
        <button id="btn" onclick="sendQuestion()">Найти</button>
      </div>
    </div>

    <!-- 4 invisible blocks for future -->
    <div class="blocks">
      <div class="block" id="block1"></div>
      <div class="block" id="block2"></div>
      <div class="block" id="block3"></div>
      <div class="block" id="block4"></div>
    </div>

    <!-- Response -->
    <div class="response-area" id="response"></div>

    <!-- Conversation history -->
    <div class="history" id="history"></div>
  </div>

  <script>
    const WEBHOOK_URL = 'https://n8n.valoryx.org/webhook/3b619514-aa9c-4d73-a3cf-d0b5f9496d05/chat';
    // DEMO MODE: set to true to preview UI with mock data (remove for production)
    const DEMO_MODE = new URLSearchParams(window.location.search).has('demo');

    let sessionId = sessionStorage.getItem('nav_session_id');
    if (!sessionId) {
      sessionId = crypto.randomUUID();
      sessionStorage.setItem('nav_session_id', sessionId);
    }

    const input = document.getElementById('query');
    const btn = document.getElementById('btn');
    const responseArea = document.getElementById('response');
    const historyArea = document.getElementById('history');

    let lastQuestion = '';
    let lastAnswerHtml = '';

    // --- Mock data for demo mode ---
    function getMockData() {
      return {
        no_results: false,
        citations: [
          {
            title: "Фигура отца в семейной системе",
            quote: "Сын, который на связи с отцом, не вступает в лишнюю борьбу (особенно с женщинами), чтобы доказать свое мужское. Дочь, которая на связи с отцом, доверяет и радуется мужскому, она не выберет \"плохого\" мужа, у нее есть опора внутри.",
            full_text: "Отец очень часто исключен. Иногда кажется, что это \"по заслугам\". Он отсутствовал, был груб, проявлял насилие. Или был недостаточной опорой (как считала мама) или не был хорошим примером для сына или дочери (как считали примерно все).\n\nМожно ли действительно восстановить связь с отцом? Нужно ли это? Как проявляется в жизни разрыв с отцом, действительно ли он как-то мешает?\n\nНа мой взгляд, да, проявляется очень сильно и непросто. Все частые сегодняшние вопросы о смысле, о том, что делать и как жить, что выбрать, как \"научиться хотеть\" и \"почувствовать драйв\" — все эти вопросы находят ответ, если видеть себя дочерью или сыном своего отца.\n\nСын, который на связи с отцом, не вступает в лишнюю борьбу (особенно с женщинами), чтобы доказать свое мужское. Дочь, которая на связи с отцом, доверяет и радуется мужскому, она не выберет \"плохого\" мужа, у нее есть опора внутри.\n\nЗапросы об отце могут быть прямые, а могут выходить во всех историях о жизненной силе: о деньгах, о выборе, об отношениях, о смысле.",
            source_url: "https://t.me/ruconstellations/874",
            tags: ["\u0441\u0435\u043c\u0435\u0439\u043d\u044b\u0435-\u0440\u0430\u0441\u0441\u0442\u0430\u043d\u043e\u0432\u043a\u0438", "\u0434\u0435\u0442\u0438", "\u043f\u0440\u0438\u043d\u044f\u0442\u0438\u0435-\u0440\u0435\u0448\u0435\u043d\u0438\u0439"]
          },
          {
            title: "А вот и про мужское",
            quote: "Быть мужчиной — это не только физиология и полевой метаболизм, это еще и принадлежность к нескольким мужским социальным системам. \"Настоящим\" мы чувствуем себя только тогда, когда система сообщает нам о нашей \"настоящести\" через принятые в ней сигналы.",
            full_text: "Быть мужчиной — это не только физиология и полевой метаболизм, это еще и принадлежность к нескольким мужским социальным системам. \"Настоящим\" мы чувствуем себя только тогда, когда система сообщает нам о нашей \"настоящести\" через принятые в ней сигналы.\n\nЭнергообмен человека в значительной степени состоит из той энергии, которую ему дадут социальные системы, которым он принадлежит. Я называю это \"сахар\" — сладость принадлежности. Чувство \"я хороший\", \"я настоящий\".\n\nНесмотря на то, что физически в наше время мы очень мало зависим от принадлежности к системам, архаичные энергетические паттерны заставляют нас этой принадлежности искать. Людям на самом деле кажется, что они погибнут, если не будут принадлежать.",
            source_url: "https://t.me/ruconstellations/3114",
            tags: ["\u043f\u043e\u043b\u0435\u0432\u0430\u044f-\u0442\u0435\u0440\u0430\u043f\u0438\u044f", "\u0441\u0435\u043c\u044c\u044f", "\u0440\u043e\u0434\u043e\u0432\u044b\u0435-\u0432\u043e\u043f\u0440\u043e\u0441\u044b"]
          },
          {
            title: "100 лет со дня рождения Берта Хеллингера",
            quote: "Хеллингер оказал огромное влияние на то, как я вижу мир. И только через это — на то, как я в итоге делаю расстановки. Внешне мои расстановки на его расстановки вообще не похожи.",
            full_text: "Я провела лично с Хеллингером всего 4 года, с 2007 до 2010. Когда-то по запросу коллег я пересчитала по сертификатам, сколько дней я с ним провела. Получилось больше 60.\n\nХеллингер никогда не создавал школу в том смысле, чтобы были отношения учитель-ученик, программа обучения, экзамены и сертификаты.\n\nСейчас, оглядываясь назад, я бы отдала именно этому отсутствию школы первое место в моем опыте с Хеллингером. То, что можно было просто приехать и свободно учиться — сейчас я считаю самым ценным даром для меня.\n\nХеллингер оказал огромное влияние на то, как я вижу мир. И только через это — на то, как я в итоге делаю расстановки. Внешне мои расстановки на его расстановки вообще не похожи.\n\nНе перестаю замирать и удивляться, что судьба мне дала возможность таки сделать это и продолжать так долго.",
            source_url: "https://t.me/ruconstellations/3825",
            tags: ["\u0440\u0430\u0441\u0441\u0442\u0430\u043d\u043e\u0432\u043a\u0438", "\u0441\u0443\u0434\u044c\u0431\u0430", "\u043f\u0440\u0430\u043a\u0442\u0438\u043a\u0430"]
          }
        ],
        related_tags: [
          {
            tag: "\u0441\u0435\u043c\u0435\u0439\u043d\u044b\u0435-\u0440\u0430\u0441\u0441\u0442\u0430\u043d\u043e\u0432\u043a\u0438",
            articles: [
              {
                title: "\u041e \u0441\u0432\u044f\u0437\u0438 \u0441 \u0440\u043e\u0434\u0438\u0442\u0435\u043b\u044f\u043c\u0438",
                full_text: "\u0421\u0432\u044f\u0437\u044c \u0441 \u0440\u043e\u0434\u0438\u0442\u0435\u043b\u044f\u043c\u0438 \u2014 \u044d\u0442\u043e \u043e\u0441\u043d\u043e\u0432\u0430 \u043d\u0430\u0448\u0435\u0439 \u0436\u0438\u0437\u043d\u0435\u043d\u043d\u043e\u0439 \u0441\u0438\u043b\u044b. \u041a\u043e\u0433\u0434\u0430 \u044d\u0442\u0430 \u0441\u0432\u044f\u0437\u044c \u043d\u0430\u0440\u0443\u0448\u0435\u043d\u0430, \u0447\u0435\u043b\u043e\u0432\u0435\u043a \u0442\u0435\u0440\u044f\u0435\u0442 \u043e\u043f\u043e\u0440\u0443 \u0438 \u043d\u0430\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435. \u0412 \u0440\u0430\u0441\u0441\u0442\u0430\u043d\u043e\u0432\u043a\u0430\u0445 \u043c\u044b \u0432\u0438\u0434\u0438\u043c, \u043a\u0430\u043a \u044d\u0442\u0430 \u0441\u0432\u044f\u0437\u044c \u043c\u043e\u0436\u0435\u0442 \u0431\u044b\u0442\u044c \u0432\u043e\u0441\u0441\u0442\u0430\u043d\u043e\u0432\u043b\u0435\u043d\u0430.",
                source_url: "https://t.me/ruconstellations/1205"
              },
              {
                title: "\u041f\u043e\u0447\u0435\u043c\u0443 \u0434\u0435\u0442\u0438 \u043f\u043e\u0432\u0442\u043e\u0440\u044f\u044e\u0442 \u0441\u0443\u0434\u044c\u0431\u044b \u0440\u043e\u0434\u0438\u0442\u0435\u043b\u0435\u0439",
                full_text: "\u0414\u0435\u0442\u0438 \u043d\u0435\u0441\u0443\u0442 \u0432 \u0441\u0435\u0431\u0435 \u043d\u0435\u0437\u0430\u0432\u0435\u0440\u0448\u0451\u043d\u043d\u044b\u0435 \u043f\u0440\u043e\u0446\u0435\u0441\u0441\u044b \u0441\u0432\u043e\u0438\u0445 \u0440\u043e\u0434\u0438\u0442\u0435\u043b\u0435\u0439. \u042d\u0442\u043e \u043d\u0435 \u043c\u0438\u0441\u0442\u0438\u043a\u0430, \u0430 \u043f\u043e\u043b\u0435\u0432\u043e\u0439 \u043f\u0440\u043e\u0446\u0435\u0441\u0441: \u0442\u043e, \u0447\u0442\u043e \u043d\u0435 \u0431\u044b\u043b\u043e \u043f\u0440\u043e\u0436\u0438\u0442\u043e, \u043f\u0435\u0440\u0435\u0434\u0430\u0451\u0442\u0441\u044f \u0434\u0430\u043b\u044c\u0448\u0435. \u0412 \u0440\u0430\u0441\u0441\u0442\u0430\u043d\u043e\u0432\u043a\u0435 \u043c\u043e\u0436\u043d\u043e \u0443\u0432\u0438\u0434\u0435\u0442\u044c \u044d\u0442\u0438 \u043f\u0435\u0440\u0435\u043f\u043b\u0435\u0442\u0435\u043d\u0438\u044f \u0438 \u0432\u0435\u0440\u043d\u0443\u0442\u044c \u043a\u0430\u0436\u0434\u043e\u043c\u0443 \u0441\u0432\u043e\u0451.",
                source_url: "https://t.me/ruconstellations/2001"
              }
            ]
          },
          {
            tag: "\u043f\u043e\u043b\u0435\u0432\u0430\u044f-\u0442\u0435\u0440\u0430\u043f\u0438\u044f",
            articles: [
              {
                title: "\u0427\u0442\u043e \u0442\u0430\u043a\u043e\u0435 \u043f\u043e\u043b\u0435\u0432\u043e\u0439 \u043c\u0435\u0442\u0430\u0431\u043e\u043b\u0438\u0437\u043c",
                full_text: "\u041f\u043e\u043b\u0435\u0432\u043e\u0439 \u043c\u0435\u0442\u0430\u0431\u043e\u043b\u0438\u0437\u043c \u2014 \u044d\u0442\u043e \u043e\u0431\u043c\u0435\u043d \u044d\u043d\u0435\u0440\u0433\u0438\u0435\u0439 \u043c\u0435\u0436\u0434\u0443 \u0447\u0435\u043b\u043e\u0432\u0435\u043a\u043e\u043c \u0438 \u0441\u0438\u0441\u0442\u0435\u043c\u0430\u043c\u0438, \u043a\u043e\u0442\u043e\u0440\u044b\u043c \u043e\u043d \u043f\u0440\u0438\u043d\u0430\u0434\u043b\u0435\u0436\u0438\u0442. \u042d\u0442\u043e\u0442 \u043e\u0431\u043c\u0435\u043d \u043f\u0440\u043e\u0438\u0441\u0445\u043e\u0434\u0438\u0442 \u043f\u043e\u0441\u0442\u043e\u044f\u043d\u043d\u043e, \u043d\u0435\u0437\u0430\u0432\u0438\u0441\u0438\u043c\u043e \u043e\u0442 \u043d\u0430\u0448\u0435\u0433\u043e \u0441\u043e\u0437\u043d\u0430\u0442\u0435\u043b\u044c\u043d\u043e\u0433\u043e \u0443\u0447\u0430\u0441\u0442\u0438\u044f. \u0412 \u043f\u043e\u043b\u0435\u0432\u043e\u0439 \u0442\u0435\u0440\u0430\u043f\u0438\u0438 \u043c\u044b \u0443\u0447\u0438\u043c\u0441\u044f \u0432\u0438\u0434\u0435\u0442\u044c \u044d\u0442\u0438 \u043f\u043e\u0442\u043e\u043a\u0438 \u0438 \u0440\u0430\u0431\u043e\u0442\u0430\u0442\u044c \u0441 \u043d\u0438\u043c\u0438.",
                source_url: "https://t.me/ruconstellations/2500"
              }
            ]
          }
        ]
      };
    }

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !btn.disabled) sendQuestion();
    });

    // --- Utility: escape HTML to prevent XSS ---
    function escapeHtml(str) {
      if (!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // --- Extract JSON from AI response (3-tier fallback) ---
    function extractJSON(raw) {
      if (!raw || typeof raw !== 'string') return null;
      const trimmed = raw.trim();

      // Attempt 1: Direct parse
      try {
        const parsed = JSON.parse(trimmed);
        if (typeof parsed === 'object' && parsed !== null) return parsed;
      } catch (e) {}

      // Attempt 2: Extract from ```json ... ``` code fence
      const fenceMatch = trimmed.match(/```(?:json)?\s*\n?([\s\S]*?)\n?\s*```/);
      if (fenceMatch) {
        try {
          const parsed = JSON.parse(fenceMatch[1].trim());
          if (typeof parsed === 'object' && parsed !== null) return parsed;
        } catch (e) {}
      }

      // Attempt 3: Find first { to last }
      const first = trimmed.indexOf('{');
      const last = trimmed.lastIndexOf('}');
      if (first !== -1 && last > first) {
        try {
          const parsed = JSON.parse(trimmed.substring(first, last + 1));
          if (typeof parsed === 'object' && parsed !== null) return parsed;
        } catch (e) {}
      }

      return null;
    }

    // --- Render structured JSON response ---
    function renderStructured(data) {
      let html = '';

      // Citations
      if (data.citations && data.citations.length > 0) {
        data.citations.forEach((c, i) => {
          html += '<div class="citation">';
          html += '<div class="citation-rank">' + (i + 1) + '</div>';
          html += '<div class="citation-content">';

          if (c.title) {
            html += '<div class="citation-title">' + escapeHtml(c.title) + '</div>';
          }

          if (c.quote) {
            html += '<blockquote class="citation-quote">\u00AB' + escapeHtml(c.quote) + '\u00BB</blockquote>';
          }

          if (c.full_text) {
            html += '<details class="citation-details">';
            html += '<summary>\u0427\u0438\u0442\u0430\u0442\u044C \u043F\u043E\u043B\u043D\u043E\u0441\u0442\u044C\u044E</summary>';
            html += '<div class="citation-full-text">' + escapeHtml(c.full_text) + '</div>';
            if (c.source_url) {
              html += '<a class="source-link" href="' + escapeHtml(c.source_url) + '" target="_blank" rel="noopener">\u0418\u0441\u0442\u043E\u0447\u043D\u0438\u043A \u2192</a>';
            }
            html += '</details>';
          } else if (c.source_url) {
            html += '<a class="source-link" href="' + escapeHtml(c.source_url) + '" target="_blank" rel="noopener">\u0418\u0441\u0442\u043E\u0447\u043D\u0438\u043A \u2192</a>';
          }

          if (c.tags && c.tags.length > 0) {
            html += '<div class="citation-tags">';
            c.tags.forEach(t => {
              html += '<span class="tag">' + escapeHtml(t) + '</span>';
            });
            html += '</div>';
          }

          html += '</div></div>';
        });
      }

      // Related tags
      if (data.related_tags && data.related_tags.length > 0) {
        html += '<div class="related-tags-section">';
        html += '<div class="related-tags-heading">\u0421\u0432\u044F\u0437\u0430\u043D\u043D\u044B\u0435 \u0442\u0435\u043C\u044B</div>';

        data.related_tags.forEach(tg => {
          html += '<div class="tag-group">';
          html += '<span class="tag-group-name">' + escapeHtml(tg.tag) + '</span>';
          html += '<div class="tag-articles">';

          if (tg.articles && tg.articles.length > 0) {
            tg.articles.forEach(a => {
              html += '<details class="tag-article">';
              html += '<summary>' + escapeHtml(a.title || '\u0421\u0442\u0430\u0442\u044C\u044F') + '</summary>';
              html += '<div class="tag-article-text">' + escapeHtml(a.full_text || '') + '</div>';
              if (a.source_url) {
                html += '<a class="source-link" href="' + escapeHtml(a.source_url) + '" target="_blank" rel="noopener">\u0418\u0441\u0442\u043E\u0447\u043D\u0438\u043A \u2192</a>';
              }
              html += '</details>';
            });
          }

          html += '</div></div>';
        });

        html += '</div>';
      }

      return html;
    }

    // --- Render "no results" ---
    function renderNoResults() {
      return '<div class="no-results">'
        + '<p>\u042F \u043D\u0435 \u043D\u0430\u0448\u0451\u043B \u0440\u0435\u043B\u0435\u0432\u0430\u043D\u0442\u043D\u044B\u0445 \u0441\u0442\u0430\u0442\u0435\u0439 \u043F\u043E \u044D\u0442\u043E\u043C\u0443 \u0437\u0430\u043F\u0440\u043E\u0441\u0443.</p>'
        + '<p>\u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u043F\u0435\u0440\u0435\u0444\u043E\u0440\u043C\u0443\u043B\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0432\u043E\u043F\u0440\u043E\u0441 \u0438\u043B\u0438 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u0434\u0440\u0443\u0433\u0438\u0435 \u043A\u043B\u044E\u0447\u0435\u0432\u044B\u0435 \u0441\u043B\u043E\u0432\u0430.</p>'
        + '</div>';
    }

    // --- Fallback: render plain text with basic markdown ---
    function renderFallback(text) {
      let t = escapeHtml(text);
      // Markdown links [text](url)
      t = t.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
      // Bold **text**
      t = t.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      // Italic *text*
      t = t.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      // Newlines
      t = t.replace(/\n/g, '<br>');
      return '<div class="fallback-text">' + t + '</div>';
    }

    // --- Main: send question ---
    async function sendQuestion() {
      const question = input.value.trim();
      if (!question) return;

      btn.disabled = true;
      btn.textContent = '\u0418\u0449\u0443...';
      input.disabled = true;

      // Move previous response to history
      if (lastQuestion && lastAnswerHtml) {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = '<div class="history-question">' + escapeHtml(lastQuestion) + '</div>'
          + '<div class="history-answer">' + lastAnswerHtml + '</div>';
        historyArea.prepend(item);
      }

      lastQuestion = question;
      lastAnswerHtml = '';
      responseArea.innerHTML = '<div class="loading">\u0418\u0449\u0443 \u043E\u0442\u0432\u0435\u0442<span class="dots"></span></div>';

      try {
        let parsed;

        if (DEMO_MODE) {
          // Demo: simulate loading delay then show mock data
          await new Promise(r => setTimeout(r, 800));
          parsed = getMockData();
        } else {
          const res = await fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'sendMessage',
              chatInput: question,
              sessionId: sessionId
            })
          });

          if (!res.ok) throw new Error('\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0430: ' + res.status);

          const data = await res.json();
          const rawOutput = data.output || data.text || data.response || JSON.stringify(data);
          parsed = extractJSON(rawOutput);
        }

        let html;
        if (parsed && (parsed.citations || parsed.no_results !== undefined)) {
          if (parsed.no_results || (!parsed.citations || parsed.citations.length === 0)) {
            html = renderNoResults();
          } else {
            html = renderStructured(parsed);
          }
        } else {
          html = renderFallback(typeof parsed === 'string' ? parsed : JSON.stringify(parsed));
        }

        lastAnswerHtml = html;
        responseArea.innerHTML = html;
      } catch (err) {
        const errHtml = '<div class="error">\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u043E\u0442\u0432\u0435\u0442. \u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u043F\u043E\u0437\u0436\u0435.<br><small>' + escapeHtml(err.message) + '</small></div>';
        responseArea.innerHTML = errHtml;
        lastAnswerHtml = errHtml;
      }

      btn.disabled = false;
      btn.textContent = '\u041D\u0430\u0439\u0442\u0438';
      input.disabled = false;
      input.value = '';
      input.focus();
    }
  </script>

</body>
</html>
