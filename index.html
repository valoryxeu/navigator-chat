<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Навигатор по знаниям — Елена Веселаго</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #fafaf9;
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    /* Logo */
    .logo {
      text-align: center;
      margin-bottom: 2rem;
    }

    .logo img {
      width: 120px;
      height: 120px;
    }

    /* Search area */
    .search-area {
      margin-bottom: 2rem;
    }

    .search-box {
      display: flex;
      gap: 8px;
    }

    .search-box input {
      flex: 1;
      padding: 14px 18px;
      font-size: 16px;
      border: 2px solid #e0dcd8;
      border-radius: 12px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      background: #fff;
    }

    .search-box input:focus {
      border-color: #b5453a;
      box-shadow: 0 0 0 3px rgba(181, 69, 58, 0.1);
    }

    .search-box button {
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      background: #b5453a;
      color: #fff;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      white-space: nowrap;
    }

    .search-box button:hover {
      background: #9a3830;
    }

    .search-box button:active {
      transform: scale(0.97);
    }

    .search-box button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    /* Suggested queries */
    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
    }

    .suggestion-chip {
      padding: 5px 12px;
      background: #fff;
      border: 1px solid #e0dcd8;
      border-radius: 20px;
      font-size: 13px;
      color: #666;
      cursor: pointer;
      transition: all 0.15s;
    }

    .suggestion-chip:hover {
      border-color: #b5453a;
      color: #b5453a;
      background: #fdf6f5;
    }

    /* Response area */
    .response-area {
      min-height: 60px;
      margin-bottom: 2rem;
    }

    /* Loading skeleton */
    .loading-skeleton {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .skeleton-card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      border-left: 4px solid #e0dcd8;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .skeleton-line {
      height: 14px;
      background: linear-gradient(90deg, #f0eeec 25%, #e8e5e2 50%, #f0eeec 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
      border-radius: 4px;
      margin-bottom: 10px;
    }

    .skeleton-line:last-child { margin-bottom: 0; }
    .skeleton-line.short { width: 40%; }
    .skeleton-line.medium { width: 70%; }
    .skeleton-line.long { width: 90%; }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Error */
    .error {
      padding: 1rem 1.5rem;
      background: #fff5f5;
      border: 1px solid #fed7d7;
      border-radius: 12px;
      color: #c53030;
    }

    /* No results */
    .no-results {
      text-align: center;
      padding: 2rem;
      color: #888;
    }

    .no-results p {
      margin-bottom: 0.5rem;
    }

    .no-results .try-these {
      margin-top: 1rem;
      font-size: 14px;
      color: #999;
    }

    /* Fallback plain text */
    .fallback-text {
      padding: 1.2rem 1.5rem;
      background: #fff;
      border-radius: 12px;
      line-height: 1.7;
      font-size: 15px;
      white-space: pre-wrap;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .fallback-text a {
      color: #b5453a;
      text-decoration: none;
    }

    .fallback-text a:hover {
      text-decoration: underline;
    }

    /* ===== Citation cards ===== */
    .citation {
      margin-bottom: 16px;
      padding: 20px;
      background: #fff;
      border-radius: 12px;
      border-left: 4px solid #b5453a;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      transition: box-shadow 0.2s;
    }

    .citation:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .citation-header {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 12px;
    }

    .citation-rank {
      flex-shrink: 0;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: #b5453a;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 13px;
      margin-top: 1px;
    }

    .citation-title {
      font-size: 16px;
      font-weight: 600;
      color: #222;
      line-height: 1.4;
    }

    .citation-quote {
      margin: 0 0 14px 0;
      padding: 12px 16px;
      background: #fdf6f5;
      border-left: 3px solid #ddb5b1;
      border-radius: 0 6px 6px 0;
      font-style: italic;
      line-height: 1.65;
      color: #555;
      font-size: 14.5px;
    }

    /* Tags on citations */
    .citation-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }

    .tag {
      display: inline-block;
      padding: 3px 11px;
      background: #f5f0ef;
      color: #8b4840;
      border-radius: 14px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid transparent;
    }

    .tag:hover {
      background: #b5453a;
      color: #fff;
      border-color: #b5453a;
    }

    /* Source link — always visible */
    .citation-source {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 10px;
    }

    .source-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
      color: #b5453a;
      text-decoration: none;
      transition: color 0.15s;
    }

    .source-link:hover {
      color: #9a3830;
      text-decoration: underline;
    }

    .source-link .arrow {
      font-size: 11px;
    }

    /* Collapsible full text */
    details.citation-details {
      border-top: 1px solid #f0eeec;
      padding-top: 8px;
    }

    details.citation-details summary,
    details.tag-article summary {
      cursor: pointer;
      color: #888;
      font-size: 13px;
      padding: 4px 0;
      user-select: none;
      font-weight: 500;
      transition: color 0.15s;
    }

    details.citation-details summary:hover,
    details.tag-article summary:hover {
      color: #b5453a;
    }

    details[open] > summary {
      margin-bottom: 10px;
      color: #b5453a;
    }

    .citation-full-text,
    .tag-article-text {
      padding: 14px;
      background: #fafaf9;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.7;
      word-wrap: break-word;
      max-height: 500px;
      overflow-y: auto;
    }

    /* Markdown rendering in full text */
    .citation-full-text h1,
    .citation-full-text h2,
    .citation-full-text h3 {
      margin: 1em 0 0.5em;
      font-size: 1.1em;
      color: #333;
    }

    .citation-full-text h1:first-child,
    .citation-full-text h2:first-child,
    .citation-full-text h3:first-child {
      margin-top: 0;
    }

    .citation-full-text p {
      margin-bottom: 0.8em;
    }

    .citation-full-text p:last-child {
      margin-bottom: 0;
    }

    .citation-full-text strong {
      color: #222;
    }

    .citation-full-text a {
      color: #b5453a;
      text-decoration: none;
    }

    .citation-full-text a:hover {
      text-decoration: underline;
    }

    .citation-full-text ul, .citation-full-text ol {
      margin: 0.5em 0;
      padding-left: 1.5em;
    }

    .citation-full-text li {
      margin-bottom: 0.3em;
    }

    .citation-full-text blockquote {
      border-left: 3px solid #ddb5b1;
      padding-left: 12px;
      margin: 0.5em 0;
      color: #666;
      font-style: italic;
    }

    /* ===== Related tags section ===== */
    .related-tags-section {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid #e8e5e2;
    }

    .related-tags-heading {
      font-size: 15px;
      font-weight: 600;
      color: #666;
      margin-bottom: 14px;
    }

    .tag-group {
      margin-bottom: 14px;
    }

    .tag-group-name {
      display: inline-block;
      padding: 4px 14px;
      margin-bottom: 8px;
      background: #b5453a;
      color: #fff;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s;
    }

    .tag-group-name:hover {
      background: #9a3830;
    }

    .tag-articles {
      margin-left: 8px;
    }

    details.tag-article {
      margin-bottom: 6px;
    }

    details.tag-article summary {
      font-size: 14px;
      color: #555;
      font-weight: 500;
    }

    details.tag-article summary:hover {
      color: #b5453a;
    }

    /* Conversation history */
    .history {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .history-item {
      border-bottom: 1px solid #f0eeec;
      padding-bottom: 1rem;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-question {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #555;
      font-size: 14px;
    }

    .history-answer {
      opacity: 0.65;
      font-size: 14px;
    }

    /* Responsive */
    @media (max-width: 480px) {
      .container {
        padding: 1rem;
      }

      .search-box {
        flex-direction: column;
      }

      .search-box button {
        padding: 12px;
      }

      .citation {
        padding: 16px;
      }

      .citation-rank {
        width: 22px;
        height: 22px;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <!-- Logo -->
    <div class="logo">
      <img src="logo.png" alt="Навигатор по знаниям">
    </div>

    <!-- Search -->
    <div class="search-area">
      <div class="search-box">
        <input type="text" id="query" placeholder="Задайте вопрос о расстановках, полевой терапии или шаманизме..." autofocus>
        <button id="btn" onclick="sendQuestion()">Найти</button>
      </div>
      <div class="suggestions" id="suggestions">
        <span class="suggestion-chip" onclick="searchTag(this.textContent)">что такое поле</span>
        <span class="suggestion-chip" onclick="searchTag(this.textContent)">отношения с отцом</span>
        <span class="suggestion-chip" onclick="searchTag(this.textContent)">шаманская работа</span>
        <span class="suggestion-chip" onclick="searchTag(this.textContent)">детские чувства</span>
      </div>
    </div>

    <!-- Response -->
    <div class="response-area" id="response"></div>

    <!-- Conversation history -->
    <div class="history" id="history"></div>
  </div>

  <script>
    const WEBHOOK_URL = 'https://n8n.valoryx.org/webhook/3b619514-aa9c-4d73-a3cf-d0b5f9496d05/chat';

    let sessionId = sessionStorage.getItem('nav_session_id');
    if (!sessionId) {
      sessionId = crypto.randomUUID();
      sessionStorage.setItem('nav_session_id', sessionId);
    }

    const input = document.getElementById('query');
    const btn = document.getElementById('btn');
    const responseArea = document.getElementById('response');
    const historyArea = document.getElementById('history');
    const suggestionsArea = document.getElementById('suggestions');

    let lastQuestion = '';
    let lastAnswerHtml = '';

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !btn.disabled) sendQuestion();
    });

    // --- Search by tag click ---
    function searchTag(tag) {
      input.value = tag;
      sendQuestion();
    }

    // --- Escape HTML to prevent XSS ---
    function escapeHtml(str) {
      if (!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // --- Simple markdown renderer ---
    function renderMarkdown(text) {
      if (!text) return '';
      let t = escapeHtml(text);
      // Headers
      t = t.replace(/^### (.+)$/gm, '<h3>$1</h3>');
      t = t.replace(/^## (.+)$/gm, '<h2>$1</h2>');
      t = t.replace(/^# (.+)$/gm, '<h1>$1</h1>');
      // Bold
      t = t.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      // Italic
      t = t.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      // Links
      t = t.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
      // Blockquotes
      t = t.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');
      // List items
      t = t.replace(/^- (.+)$/gm, '<li>$1</li>');
      t = t.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
      // Deduplicate nested ul
      t = t.replace(/<\/ul>\s*<ul>/g, '');
      // Paragraphs: double newline
      t = t.replace(/\n\n/g, '</p><p>');
      // Single newlines
      t = t.replace(/\n/g, '<br>');
      // Wrap in paragraph
      if (!t.startsWith('<h') && !t.startsWith('<ul') && !t.startsWith('<blockquote')) {
        t = '<p>' + t + '</p>';
      }
      return t;
    }

    // --- Extract JSON from AI response (3-tier fallback) ---
    function extractJSON(raw) {
      if (!raw || typeof raw !== 'string') return null;
      const trimmed = raw.trim();

      // Attempt 1: Direct parse
      try {
        const parsed = JSON.parse(trimmed);
        if (typeof parsed === 'object' && parsed !== null) return parsed;
      } catch (e) {}

      // Attempt 2: Extract from ```json ... ``` code fence
      const fenceMatch = trimmed.match(/```(?:json)?\s*\n?([\s\S]*?)\n?\s*```/);
      if (fenceMatch) {
        try {
          const parsed = JSON.parse(fenceMatch[1].trim());
          if (typeof parsed === 'object' && parsed !== null) return parsed;
        } catch (e) {}
      }

      // Attempt 3: Find first { to last }
      const first = trimmed.indexOf('{');
      const last = trimmed.lastIndexOf('}');
      if (first !== -1 && last > first) {
        try {
          const parsed = JSON.parse(trimmed.substring(first, last + 1));
          if (typeof parsed === 'object' && parsed !== null) return parsed;
        } catch (e) {}
      }

      return null;
    }

    // --- Render structured JSON response ---
    function renderStructured(data) {
      let html = '';

      // Citations
      if (data.citations && data.citations.length > 0) {
        data.citations.forEach((c, i) => {
          html += '<div class="citation">';

          // Header: rank + title
          html += '<div class="citation-header">';
          html += '<div class="citation-rank">' + (i + 1) + '</div>';
          if (c.title) {
            html += '<div class="citation-title">' + escapeHtml(c.title) + '</div>';
          }
          html += '</div>';

          // Quote
          if (c.quote) {
            html += '<blockquote class="citation-quote">\u00AB' + escapeHtml(c.quote) + '\u00BB</blockquote>';
          }

          // Tags — clickable
          if (c.tags && c.tags.length > 0) {
            html += '<div class="citation-tags">';
            c.tags.forEach(t => {
              html += '<span class="tag" onclick="searchTag(\'' + escapeHtml(t).replace(/'/g, "\\'") + '\')">' + escapeHtml(t) + '</span>';
            });
            html += '</div>';
          }

          // Source link — always visible
          if (c.source_url) {
            html += '<div class="citation-source">';
            html += '<a class="source-link" href="' + escapeHtml(c.source_url) + '" target="_blank" rel="noopener">';
            html += 'Источник <span class="arrow">\u2192</span>';
            html += '</a>';
            html += '</div>';
          }

          // Full text — collapsible with markdown rendering
          if (c.full_text) {
            html += '<details class="citation-details">';
            html += '<summary>Читать полностью</summary>';
            html += '<div class="citation-full-text">' + renderMarkdown(c.full_text) + '</div>';
            html += '</details>';
          }

          html += '</div>';
        });
      }

      // Related tags
      if (data.related_tags && data.related_tags.length > 0) {
        html += '<div class="related-tags-section">';
        html += '<div class="related-tags-heading">Связанные темы</div>';

        data.related_tags.forEach(tg => {
          html += '<div class="tag-group">';
          html += '<span class="tag-group-name" onclick="searchTag(\'' + escapeHtml(tg.tag).replace(/'/g, "\\'") + '\')">' + escapeHtml(tg.tag) + '</span>';
          html += '<div class="tag-articles">';

          if (tg.articles && tg.articles.length > 0) {
            tg.articles.forEach(a => {
              html += '<details class="tag-article">';
              html += '<summary>' + escapeHtml(a.title || 'Статья') + '</summary>';
              html += '<div class="tag-article-text">' + renderMarkdown(a.full_text || '') + '</div>';
              if (a.source_url) {
                html += '<a class="source-link" href="' + escapeHtml(a.source_url) + '" target="_blank" rel="noopener" style="display:inline-block;margin-top:8px;">Источник <span class="arrow">\u2192</span></a>';
              }
              html += '</details>';
            });
          }

          html += '</div></div>';
        });

        html += '</div>';
      }

      return html;
    }

    // --- Render "no results" ---
    function renderNoResults() {
      return '<div class="no-results">'
        + '<p>По этому запросу ничего не найдено.</p>'
        + '<div class="try-these">Попробуйте:</div>'
        + '<div class="suggestions" style="justify-content:center;margin-top:8px;">'
        + '<span class="suggestion-chip" onclick="searchTag(this.textContent)">расстановки</span>'
        + '<span class="suggestion-chip" onclick="searchTag(this.textContent)">полевая терапия</span>'
        + '<span class="suggestion-chip" onclick="searchTag(this.textContent)">родовые вопросы</span>'
        + '</div>'
        + '</div>';
    }

    // --- Fallback: render plain text ---
    function renderFallback(text) {
      return '<div class="fallback-text">' + renderMarkdown(text) + '</div>';
    }

    // --- Loading skeleton ---
    function renderLoading() {
      let html = '<div class="loading-skeleton">';
      for (let i = 0; i < 2; i++) {
        html += '<div class="skeleton-card">';
        html += '<div class="skeleton-line short"></div>';
        html += '<div class="skeleton-line long"></div>';
        html += '<div class="skeleton-line medium"></div>';
        html += '</div>';
      }
      html += '</div>';
      return html;
    }

    // --- Main: send question ---
    async function sendQuestion() {
      const question = input.value.trim();
      if (!question) return;

      btn.disabled = true;
      btn.textContent = 'Ищу...';
      input.disabled = true;
      suggestionsArea.style.display = 'none';

      // Move previous response to history
      if (lastQuestion && lastAnswerHtml) {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = '<div class="history-question">' + escapeHtml(lastQuestion) + '</div>'
          + '<div class="history-answer">' + lastAnswerHtml + '</div>';
        historyArea.prepend(item);
      }

      lastQuestion = question;
      lastAnswerHtml = '';
      responseArea.innerHTML = renderLoading();

      try {
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'sendMessage',
            chatInput: question,
            sessionId: sessionId
          })
        });

        if (!res.ok) throw new Error('Ошибка сервера: ' + res.status);

        const data = await res.json();
        const rawOutput = data.output || data.text || data.response || JSON.stringify(data);
        const parsed = extractJSON(rawOutput);

        let html;
        if (parsed && (parsed.citations || parsed.no_results !== undefined)) {
          if (parsed.no_results || (!parsed.citations || parsed.citations.length === 0)) {
            html = renderNoResults();
          } else {
            html = renderStructured(parsed);
          }
        } else {
          html = renderFallback(typeof rawOutput === 'string' ? rawOutput : JSON.stringify(rawOutput));
        }

        lastAnswerHtml = html;
        responseArea.innerHTML = html;
      } catch (err) {
        const errHtml = '<div class="error">Не удалось получить ответ. Попробуйте позже.<br><small>' + escapeHtml(err.message) + '</small></div>';
        responseArea.innerHTML = errHtml;
        lastAnswerHtml = errHtml;
      }

      btn.disabled = false;
      btn.textContent = 'Найти';
      input.disabled = false;
      input.value = '';
      input.focus();
    }
  </script>

</body>
</html>
